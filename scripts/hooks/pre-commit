#!/bin/bash

# Pre-commit hook for Peoplo
# Validates version format and changelog updates

set -e

VERSION_FILE="src/lib/version.ts"

# Check if version.ts is staged for commit
if ! git diff --cached --name-only | grep -q "$VERSION_FILE"; then
  exit 0
fi

echo "üîç Checking version.ts changes..."

# Get the staged content
STAGED_CONTENT=$(git show :$VERSION_FILE)

# Extract APP_VERSION
APP_VERSION=$(echo "$STAGED_CONTENT" | grep -oP 'APP_VERSION = "\K[^"]+' || true)

if [ -z "$APP_VERSION" ]; then
  echo "‚ùå Error: Could not find APP_VERSION in $VERSION_FILE"
  exit 1
fi

# Validate semver format (X.Y.Z)
if ! echo "$APP_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
  echo "‚ùå Error: Invalid version format '$APP_VERSION'"
  echo "   Expected format: X.Y.Z (e.g., 1.0.0, 2.1.3)"
  exit 1
fi

echo "‚úÖ Version format valid: $APP_VERSION"

# Check if LOCAL_CHANGELOG contains the current version
if ! echo "$STAGED_CONTENT" | grep -q "version: \"$APP_VERSION\""; then
  echo "‚ùå Error: LOCAL_CHANGELOG does not contain an entry for version $APP_VERSION"
  echo ""
  echo "   Please add a changelog entry in src/lib/version.ts:"
  echo ""
  echo "   {"
  echo "     version: \"$APP_VERSION\","
  echo "     date: \"$(date +%Y-%m-%d)\","
  echo "     type: \"patch\","
  echo "     title: \"Your Release Title\","
  echo "     description: \"Brief description of changes\","
  echo "     changes: ["
  echo "       { type: \"feature\", text: \"Description of change\" },"
  echo "     ],"
  echo "   },"
  echo ""
  exit 1
fi

echo "‚úÖ Changelog entry found for version $APP_VERSION"

# Check if FALLBACK_VERSION_RESPONSE has matching version
FALLBACK_VERSION=$(echo "$STAGED_CONTENT" | grep -A1 'FALLBACK_VERSION_RESPONSE' | grep -oP 'currentVersion: "\K[^"]+' || true)

if [ -n "$FALLBACK_VERSION" ] && [ "$FALLBACK_VERSION" != "$APP_VERSION" ]; then
  echo "‚ö†Ô∏è  Warning: FALLBACK_VERSION_RESPONSE.currentVersion ($FALLBACK_VERSION) differs from APP_VERSION ($APP_VERSION)"
  echo "   Consider updating FALLBACK_VERSION_RESPONSE to match."
fi

echo ""
echo "üéâ Version validation passed!"
exit 0
