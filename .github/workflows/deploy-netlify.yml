name: Deploy to Netlify

on:
  push:
    branches: [NETLIFY]
  pull_request:
    branches: [NETLIFY]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Update APP_VERSION from git tag
        run: |
          chmod +x scripts/update-version.sh
          ./scripts/update-version.sh

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deploy to Netlify (Production)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Deploy to Netlify (Preview)
        if: github.event_name == 'pull_request'
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Preview Deploy from PR #${{ github.event.pull_request.number }}"
          enable-pull-request-comment: true
          enable-commit-comment: false
          overwrites-pull-request-comment: true
          alias: preview-pr-${{ github.event.pull_request.number }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

# ============================================================================
# SETUP INSTRUCTIONS
# ============================================================================
#
# 1. Create a Netlify account and site:
#    - Go to https://app.netlify.com
#    - Create a new site (can import from GitHub or create blank)
#
# 2. Add the following secrets to your GitHub repository:
#    (Settings > Secrets and variables > Actions > New repository secret)
#
#    NETLIFY_AUTH_TOKEN:
#      - Go to https://app.netlify.com/user/applications#personal-access-tokens
#      - Create a new personal access token
#      - Copy the token value
#
#    NETLIFY_SITE_ID:
#      - Go to your Netlify site dashboard
#      - Site settings > General > Site details > Site ID
#      - Copy the Site ID (looks like: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
#
#    VITE_SUPABASE_URL:
#      - Your Supabase project URL (e.g., https://xxxxx.supabase.co)
#
#    VITE_SUPABASE_ANON_KEY:
#      - Your Supabase anon/public key
#
# 3. Configure build settings in Netlify (optional, already handled by workflow):
#    - Build command: npm run build
#    - Publish directory: dist
#
# 4. Add _redirects file for SPA routing (create public/_redirects):
#    /*    /index.html   200
#
# ============================================================================
